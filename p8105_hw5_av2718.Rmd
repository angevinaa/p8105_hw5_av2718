---
title: "p8105_hw5_av2718"
author: "Angelica Vina Albarracin"
date: "2022-11-16"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, message = FALSE)

library(dplyr)
library(tidyverse)
library(rvest)

theme_set(theme_minimal())

```

Problem 2


```{r}
#Load data raw data
homicide_raw = read_csv("data/homicide-data.csv") %>% 
  janitor::clean_names()

#Visualize first 8 rows
head(homicide_raw, 8) # view first 8 rows of tidied data
```

This problem focuses on the `Homicide-data.csv` that The Washington Post gathered in 50 large U.S. cities and made available through GitHub. The raw data comprises `r dim(homicide_raw)`observations. The data included the geographical location of the homicide, whether an arrest was made, and, in most cases, basic demographic information about each victim. In total, the dataset contains 12 variables: `r ls(homicide_raw)`. Interestingly, the first and last names of the victims are included in the data, as well as the exact location of the homicide (lat and log). 

In the code chunk below, we create a `city_state variable` (e.g., “Baltimore, MD”) and then summarize within cities to obtain the number of homicides and the number of unsolved homicides per city (“Closed without arrest” or “Open/No arrest”). Then, we calculate the total number of homicides per city by adding a new column to the resulting dataset.

```{r}
#Clean and arrange raw variables

homicide_clean = homicide_raw %>% 
  mutate(.data = ., city_state = str_c(city, ", " ,state)) %>% 
  select(-city, -state) %>% 
  mutate(
    disposition = if_else(disposition %in% c("Closed without arrest", "Open/No arrest"), "unsolved_homicides", "homicides") 
  )

# Create new dataset with homicides and unsolved homicides summarized by city_sate

homicide_cities = homicide_clean %>% 
  group_by(city_state, disposition) %>% 
  summarize(n_obs = n())  

homicide_cities = pivot_wider(
  homicide_cities,
  names_from = "disposition",
  values_from = "n_obs") 
homicide_cities[is.na(homicide_cities)]<- 0 #Change NA values to 0

#Add column with total number of homocides

homicide_cities = 
  mutate(homicide_cities,
  total_homicides = homicides + unsolved_homicides)

#Visualize first 8 rows of new dataframe

head(homicide_cities, 8) # view first 8 rows of tidied data

```

For the city of Baltimore, MD, in the code chunk below, we use the `propw.test`  function to estimate the proportion of unsolved homicides. Then and apply the `broom::tidy` function from the broom package to constructs a `tibble` that summarizes the findings.

```{r}
#Filter Baltimore data

baltimore_homicides = homicide_cities %>% 
  filter(city_state == "Baltimore, MD") 

#Prop.test

prop_test = prop.test(
  x = pull(baltimore_homicides , unsolved_homicides),
  n = pull(baltimore_homicides, total_homicides)) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)

prop_test
```
*Proportion of homicides in Baltimore:* As reported above, the estimate proportion of unsolved homicides in Baltimore city is `r pull(prop_test, estimate)`, with a confidence interval between `r pull(prop_test, conf.low)` and `r pull(prop_test, conf.high)`.

Lastly, we run a `prop.test` for each city and extract the proportion of unsolved homicides and the confidence interval for each. To do this, we create a `func_prop.test' that we then apply to the entire data frame.  

```{r}
#Create prop.test function

func_prop.test = function(homicide_cities){
  prop_test_cities = prop.test(
    x = pull(homicide_cities , unsolved_homicides),
    n = pull(homicide_cities, total_homicides)) %>% 
    broom::tidy() %>% 
    select(estimate, conf.low, conf.high)

prop_test_cities
}

#Extract proportion of unsolved homicides and CIs for each

prop_homicides = homicide_cities %>% 
  nest(data = unsolved_homicides:total_homicides) %>% 
  mutate(results = map(data, func_prop.test)) %>% 
  select(city_state, results) %>% 
  unnest(cols = results) 

#Visualize first 3 rows of results

head(prop_homicides, 3) # view first 8 rows of tidied data

```

#### Proportion of Unsolved Homicides in US cities


```{r}

plot_homicides = prop_homicides %>% 
  select(city_state, estimate, conf.low, conf.high) %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>% #reorder cities according to proportion of homicides
  ggplot(aes( y = estimate, x = city_state)) +
  geom_point(color = 4) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + # add error bars based on CIs 
  labs(title = "Proportion of Unsolved Homicides in Largest US Cities", 
         x = "US Cities", 
         y = "Proportion of Unsolved Homicides")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  theme(axis.text.y = element_text(size = 6)) +
  theme(plot.title = element_text(hjust = 0)) +
  theme(axis.ticks = element_blank()) +
  theme(axis.text = element_text(size = 7)) +
  theme(legend.title = element_text(size = 8)) +
  theme(legend.text = element_text(size = 6)) +
  theme(plot.title = element_text(hjust = 0.5))

  plot_homicides
  
  
ggsave("Homicides_US.Cities.png", plot = last_plot())
       
```
```

